name: PHP-CS-Fixer

on:
  pull_request:
    paths:
      - '**.php'
    types: [labeled, synchronize]

jobs:
  php-cs-fixer:
    if: contains(github.event.pull_request.labels.*.name, 'php-cs-fixer')
    runs-on: ubuntu-latest
    permissions:
      contents: write # PHPフォーマッターによるコミットをプッシュするために必要
    env:
      HEAD_REF: ${{ github.head_ref }}
      BASE_REF: ${{ github.base_ref }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: php-cs-fixer:2

      # メンテナンス用にバージョン確認をしておく
      - name: Check PHP CS Fixer version
        run: php-cs-fixer --version

      # 差分が検出されたファイルかつ.php-cs-fixer.php内で定義したphpファイルのみをphp-cs-fixerに回す
      - name: Get changed PHP files
        id: changed-files
        working-directory: ./
        run: |
          git fetch origin ${{ env.BASE_REF }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/${{ env.BASE_REF }}...HEAD | grep '\.php$' || true)

          FILTERED_FILES=""
          TARGET_DIRS="app config database routes tests"

          for file in $CHANGED_FILES; do
            for dir in $TARGET_DIRS; do
              if [[ $file == $dir/* ]]; then
                FILTERED_FILES="$FILTERED_FILES $file"
                break
              fi
            done
          done

          echo "files=$FILTERED_FILES" >> $GITHUB_OUTPUT
          echo "Changed PHP files in target directories: $FILTERED_FILES"

      # dry-run php-cs-fixer
      - name: Dry Run PHP CS Fixer on changed files
        if: steps.changed-files.outputs.files != ''
        working-directory: ./
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "[Dry Run]Formatting: $file"
              php-cs-fixer fix "$file" --config=.php-cs-fixer.dist.php --dry-run --verbose --diff --using-cache=no || true
            fi
          done

      - name: Run PHP CS Fixer on changed files
        if: steps.changed-files.outputs.files != ''
        working-directory: ./
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "Formatting: $file"
              php-cs-fixer fix "$file" --config=.php-cs-fixer.dist.php --verbose --diff --using-cache=no
            fi
          done

      - name: Commit changes
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add $CHANGED_FILES
          git diff --quiet && git diff --staged --quiet || git commit -m "[Auto] Apply PHP CS Fixer formatting"

      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref }}
