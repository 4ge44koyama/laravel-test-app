name: PHP-Insights-Report

on:
  # php-insights-run.ymlãŒå®Ÿè¡Œã•ã‚ŒãŸã¨ãã«é€£å‹•ã—ã¦å®Ÿè¡Œ
  workflow_run:
    workflows:
      - "PHP-Insights-Run"
    types:
      - completed

jobs:
  php-insights-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read # èª­ã¿å–ã‚Šã®ã¿
      pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦

    steps:
      - name: Download artifact
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }},
            });

            const matchArtifact = artifacts.data.artifacts.find(artifact => 
              artifact.name === 'insights-results'
            );

            if (!matchArtifact) {
              core.setFailed('Artifact not found');
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });

            const fs = require('fs');
              fs.writeFileSync('insights-results.zip', Buffer.from(download.data));

      - name: Extract artifact
        run: |
          mkdir -p insights-result
          unzip insights-results.zip -d insights-result/

      - name: Verify PR number
        id: verify
        run: |
          PR_NUM=$(cat insights-result/pr-number.txt)
          if ! [[ "$PR_NUM" =~ ^[0-9]+$ ]]; then
            echo "Invalid PR number: $PR_NUM"
            exit 1
          fi
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

      - name: Comment PR with Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('insights-result/phpinsights.json', 'utf8'));
            const prNumber = '${{ steps.verify.outputs.pr_number }}';

            const summary = results.summary || {};

            const getEmoji = (score) => {
              if (score >= 90) return 'ðŸŸ¢';
              if (score >= 70) return 'ðŸŸ¡';
              return 'ðŸ”´';
            };

            let comment = '## ðŸ“Š PHP Insights Summary\n\n';
            comment += '| Metric | Score |\n';
            comment += '|--------|-------|\n';
            comment += `| ${getEmoji(summary.code)} Code | **${summary.code}%** |\n`;
            comment += `| ${getEmoji(summary.complexity)} Complexity | **${summary.complexity}%** |\n`;
            comment += `| ${getEmoji(summary.architecture)} Architecture | **${summary.architecture}%** |\n`;
            comment += `| ${getEmoji(summary.style)} Style | **${summary.style}%** |\n`;

            const securityIssues = summary['security issues'] || 0;
            comment += `| ${securityIssues === 0 ? 'âœ…' : 'âš ï¸'} Security Issues | **${securityIssues}** |\n\n`;

            const codeIssues = (results.Code || []).length;
            const styleIssues = (results.Style || []).length;
            const architectureIssues = (results.Architecture || []).length;

            comment += '### ðŸ“‹ Issues Breakdown\n\n';
            comment += `- ðŸ”§ Code: ${codeIssues} issues\n`;
            comment += `- ðŸŽ¨ Style: ${styleIssues} issues\n`;
            comment += `- ðŸ—ï¸ Architecture: ${architectureIssues} issues\n\n`;

            const allIssues = [...(results.Code || []), ...(results.Style || [])];
            const issuesWithLine = allIssues.filter(i => i.file && i.line);

            if (issuesWithLine.length > 0) {
              comment += '### ðŸ” Top Issues\n\n';
              const top10 = issuesWithLine.slice(0, 10);
              top10.forEach((issue, idx) => {
                const file = issue.file.replace(/^.*\/laravel-test-app\//, '');
                comment += `${idx + 1}. **${issue.title}** in \`${file}:${issue.line}\`\n`;
              });

              if (issuesWithLine.length > 10) {
                comment += `\n_...and ${issuesWithLine.length - 10} more issues_\n`;
              }
            }

            comment += '\n---\n';
            comment += '_For detailed analysis, run:_\n';
            comment += '```bash\n';
            comment += 'php -d memory_limit=512M artisan insights\n';
            comment += '```';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Add php-insights label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.verify.outputs.pr_number }}';

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const hasLabel = issue.labels.some(label => label.name === 'php-insights');

            if (!hasLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['php-insights']
              });
            }
