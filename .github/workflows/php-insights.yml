name: PHP Insights(reviewdog)

on:
  pull_request:
    paths:
      - '**.php'
    types: [opened, synchronize, reopened]

jobs:
  php-insights:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Pull Requestã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å¿…è¦
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-suggest --prefer-dist

      - name: Run PHP Insights
        run: |
          php artisan insights -n --ansi --format=json > phpinsights.json || true

      - name: Convert JSON to reviewdog format
        run: |
          cat phpinsights.json | jq -r '
            .. | 
            objects | 
            select(.file != null and .line != null) | 
            "\(.file):\(.line):1: \(.message)"
          ' > phpinsights.txt

      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1

      - name: Report via reviewdog
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat phpinsights.txt | reviewdog -efm="%f:%l:%c: %m" \
            -name="PHP Insights" -reporter=github-pr-review \
            -filter-mode=diff_context -fail-on-error=false

      - name: Comment PR with Summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('phpinsights.json', 'utf8'));

            // ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’å–å¾—
            const summary = results.summary || {};

            // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸçµµæ–‡å­—
            const getEmoji = (score) => {
              if (score >= 90) return 'ğŸŸ¢';
              if (score >= 70) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };

            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
            let comment = '## ğŸ“Š PHP Insights Summary\n\n';
            comment += '| Metric | Score |\n';
            comment += '|--------|-------|\n';
            comment += `| ${getEmoji(summary.code)} Code | **${summary.code}%** |\n`;
            comment += `| ${getEmoji(summary.complexity)} Complexity | **${summary.complexity}%** |\n`;
            comment += `| ${getEmoji(summary.architecture)} Architecture | **${summary.architecture}%** |\n`;
            comment += `| ${getEmoji(summary.style)} Style | **${summary.style}%** |\n`;

            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®æ•°
            const securityIssues = summary['security issues'] || 0;
            comment += `| ${securityIssues === 0 ? 'âœ…' : 'âš ï¸'} Security Issues | **${securityIssues}** |\n\n`;

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®å•é¡Œæ•°
            const codeIssues = (results.Code || []).length;
            const styleIssues = (results.Style || []).length;
            const architectureIssues = (results.Architecture || []).length;

            comment += '### ğŸ“‹ Issues Breakdown\n\n';
            comment += `- ğŸ”§ Code: ${codeIssues} issues\n`;
            comment += `- ğŸ¨ Style: ${styleIssues} issues\n`;
            comment += `- ğŸ—ï¸ Architecture: ${architectureIssues} issues\n\n`;

            // ãƒˆãƒƒãƒ—5ã®å•é¡Œ
            const allIssues = [...(results.Code || []), ...(results.Style || [])];
            const issuesWithLine = allIssues.filter(i => i.file && i.line);

            if (issuesWithLine.length > 0) {
              comment += '### ğŸ” Top Issues\n\n';
              const top5 = issuesWithLine.slice(0, 5);
              top5.forEach((issue, idx) => {
                const file = issue.file.replace(/^.*\/laravel-test-app\//, '');
                comment += `${idx + 1}. **${issue.title}** in \`${file}:${issue.line}\`\n`;
              });

              if (issuesWithLine.length > 5) {
                comment += `\n_...and ${issuesWithLine.length - 5} more issues_\n`;
              }
            }

            comment += '\n---\n';
            comment += '_ğŸ’¡ Detailed feedback available in the Files Changed tab_';

            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
